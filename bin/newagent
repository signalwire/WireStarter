#!/bin/bash
# newagent - Create a new SignalWire agent project with full structure
# Usage: newagent <project_name>

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

usage() {
    echo "Usage: newagent <project_name>"
    echo ""
    echo "Creates a new SignalWire agent project with:"
    echo "  - Full directory structure (agents/, skills/, tests/, web/)"
    echo "  - Main agent using AgentBase with tool decorators"
    echo "  - Entry point with environment loading"
    echo "  - Test scaffolding with pytest"
    echo "  - Pre-configured .env with SignalWire credentials"
    echo "  - Python virtual environment"
    echo ""
    echo "Example:"
    echo "  newagent mybot"
    echo "  cd /workdir/mybot"
    echo "  up"
    exit 1
}

# Check for project name
if [ -z "$1" ]; then
    usage
fi

NAME="$1"
PROJECT_DIR="/workdir/$NAME"

# Check if directory exists
if [ -d "$PROJECT_DIR" ]; then
    print_warning "Directory $PROJECT_DIR already exists"
    read -p "Overwrite? (y/n): " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "Aborted."
        exit 0
    fi
    rm -rf "$PROJECT_DIR"
fi

print_step "Creating SignalWire agent project: $NAME"

# Create directory structure
mkdir -p "$PROJECT_DIR"/{agents,skills,tests,web}
cd "$PROJECT_DIR"

# Get credentials from environment or /workdir/.env
if [ -f /workdir/.env ]; then
    source /workdir/.env 2>/dev/null || true
fi

# Standard variable names
SW_SPACE="${SIGNALWIRE_SPACE_NAME:-}"
SW_PROJECT="${SIGNALWIRE_PROJECT_ID:-}"
SW_TOKEN="${SIGNALWIRE_TOKEN:-}"
NGROK_URL="${NGROK_URL:-}"

# Try to get ngrok URL if not set
if [ -z "$NGROK_URL" ]; then
    NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url // empty' 2>/dev/null || true)
fi

# Generate random password for basic auth
BASIC_AUTH_PASS=$(openssl rand -base64 32 | tr -d '/+=' | head -c 32)

print_step "Creating project files..."

# Create agents/__init__.py
cat > agents/__init__.py << 'EOF'
from .main_agent import MainAgent

__all__ = ["MainAgent"]
EOF
print_success "agents/__init__.py"

# Create main agent module
cat > agents/main_agent.py << 'EOF'
#!/usr/bin/env python3
"""Main Agent - SignalWire AI Agent"""

import os
from signalwire_agents import AgentBase, SwaigFunctionResult


class MainAgent(AgentBase):
    """Main voice AI agent."""

    def __init__(self):
        super().__init__(
            name="main-agent",
            route="/swml",
            host=os.getenv("HOST", "0.0.0.0"),
            port=int(os.getenv("PORT", "5000")),
            static_folder="web",
            static_url_path="/"
        )

        # Set basic auth if configured
        user = os.getenv("SWML_BASIC_AUTH_USER")
        password = os.getenv("SWML_BASIC_AUTH_PASSWORD")
        if user and password:
            self.set_params({
                "swml_basic_auth_user": user,
                "swml_basic_auth_password": password,
            })

        self._configure_voice()
        self._configure_prompts()

    def _configure_voice(self):
        """Set up voice and language."""
        self.add_language("English", "en-US", "rime.spore")

        self.set_params({
            "end_of_speech_timeout": 500,
            "attention_timeout": 15000,
        })

    def _configure_prompts(self):
        """Set up AI prompts."""
        self.prompt_add_section(
            "Role",
            "You are a helpful AI assistant. "
            "Help callers with their questions and requests."
        )

        self.prompt_add_section(
            "Guidelines",
            body="Follow these guidelines:",
            bullets=[
                "Be professional and courteous",
                "Ask clarifying questions when needed",
                "Keep responses concise and helpful",
                "If you cannot help, offer to transfer to a human"
            ]
        )

    @AgentBase.tool(
        name="get_info",
        description="Get information about a topic",
        parameters={
            "type": "object",
            "properties": {
                "topic": {
                    "type": "string",
                    "description": "The topic to get information about"
                }
            },
            "required": ["topic"]
        }
    )
    def get_info(self, args, raw_data):
        """Get information about a topic."""
        topic = args.get("topic", "")
        # TODO: Implement your logic here
        return SwaigFunctionResult(f"Information about {topic}: This is a placeholder response.")

    def on_summary(self, summary):
        """Handle call summary."""
        print(f"Call summary: {summary}")


# Allow running directly for testing
if __name__ == "__main__":
    agent = MainAgent()
    agent.run()
EOF
print_success "agents/main_agent.py"

# Create skills/__init__.py
cat > skills/__init__.py << 'EOF'
"""Skills module - Add reusable agent skills here."""
EOF
print_success "skills/__init__.py"

# Create app.py entry point
cat > app.py << 'EOF'
#!/usr/bin/env python3
"""Main entry point for the agent server."""

import os
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

from agents import MainAgent


def main():
    agent = MainAgent()

    host = os.getenv("HOST", "0.0.0.0")
    port = int(os.getenv("PORT", "5000"))

    print(f"Starting agent server on {host}:{port}")
    print(f"SWML endpoint: http://{host}:{port}/swml")
    print(f"Web root: http://{host}:{port}/")

    # Show public URL if available
    proxy_url = os.getenv("SWML_PROXY_URL_BASE")
    if proxy_url:
        print(f"Public SWML: {proxy_url}/swml")

    agent.run()


if __name__ == "__main__":
    main()
EOF
print_success "app.py"

# Create tests/__init__.py
cat > tests/__init__.py << 'EOF'
"""Test package."""
EOF

# Create tests/test_agent.py
cat > tests/test_agent.py << 'EOF'
#!/usr/bin/env python3
"""Tests for the main agent."""

import pytest
from agents import MainAgent


class TestMainAgent:
    """Test suite for MainAgent."""

    def test_agent_creation(self):
        """Test that agent can be instantiated."""
        agent = MainAgent()
        assert agent is not None
        assert agent.name == "main-agent"

    def test_get_info_tool(self):
        """Test the get_info tool."""
        agent = MainAgent()
        result = agent.get_info({"topic": "test"}, {})
        assert "test" in str(result)


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
EOF
print_success "tests/test_agent.py"

# Create .env file with credentials
cat > .env << ENVEOF
# SignalWire Credentials
SIGNALWIRE_SPACE_NAME=${SW_SPACE}
SIGNALWIRE_PROJECT_ID=${SW_PROJECT}
SIGNALWIRE_TOKEN=${SW_TOKEN}

# Agent Server Configuration
HOST=0.0.0.0
PORT=5000

# Basic Auth for SWML webhooks
SWML_BASIC_AUTH_USER=signalwire
SWML_BASIC_AUTH_PASSWORD=${BASIC_AUTH_PASS}

# Public URL (ngrok tunnel)
SWML_PROXY_URL_BASE=${NGROK_URL}
ENVEOF
print_success ".env"

# Create .env.example (without secrets)
cat > .env.example << 'EOF'
# SignalWire Credentials
SIGNALWIRE_SPACE_NAME=your-space
SIGNALWIRE_PROJECT_ID=your-project-id
SIGNALWIRE_TOKEN=your-api-token

# Agent Server Configuration
HOST=0.0.0.0
PORT=5000

# Basic Auth for SWML webhooks
SWML_BASIC_AUTH_USER=signalwire
SWML_BASIC_AUTH_PASSWORD=your-secure-password

# Public URL (ngrok tunnel or production domain)
SWML_PROXY_URL_BASE=https://your-domain.ngrok.io
EOF
print_success ".env.example"

# Create .gitignore
cat > .gitignore << 'EOF'
# Environment
.env
.venv/
venv/
__pycache__/
*.pyc
*.pyo

# IDE
.vscode/
.idea/
*.swp
*.swo

# Testing
.pytest_cache/
.coverage
htmlcov/

# Build
dist/
build/
*.egg-info/

# Logs
*.log

# OS
.DS_Store
Thumbs.db
EOF
print_success ".gitignore"

# Create requirements.txt
cat > requirements.txt << 'EOF'
signalwire-agents>=2.0.0
flask>=2.0.0
python-dotenv>=1.0.0
requests>=2.28.0
pytest>=7.0.0
EOF
print_success "requirements.txt"

# Create README.md
cat > README.md << READMEEOF
# ${NAME}

A SignalWire AI Agent built with signalwire-agents.

## Quick Start

\`\`\`bash
# Activate the virtual environment (auto-activates in WireStarter)
cd /workdir/${NAME}

# Run the agent
up

# Or run directly
python app.py
\`\`\`

## Project Structure

\`\`\`
${NAME}/
├── agents/
│   ├── __init__.py
│   └── main_agent.py    # Main agent implementation
├── skills/
│   └── __init__.py      # Reusable skills
├── tests/
│   └── test_agent.py    # Test suite
├── web/
│   └── index.html       # Static files
├── app.py               # Entry point (run with 'up')
├── .env                 # Environment configuration
└── requirements.txt     # Python dependencies
\`\`\`

## Configuration

Edit \`.env\` to configure:

- **SIGNALWIRE_SPACE_NAME** - Your SignalWire space name
- **SIGNALWIRE_PROJECT_ID** - Your SignalWire project ID
- **SIGNALWIRE_TOKEN** - Your SignalWire API token
- **HOST/PORT** - Server binding (default: 0.0.0.0:5000)
- **SWML_BASIC_AUTH_USER/PASSWORD** - Basic auth for SWML webhooks
- **SWML_PROXY_URL_BASE** - Public URL for webhooks (ngrok URL)

## Adding Tools

Add new tools to your agent using the \`@AgentBase.tool\` decorator:

\`\`\`python
@AgentBase.tool(
    name="my_tool",
    description="What this tool does",
    parameters={
        "type": "object",
        "properties": {
            "param1": {"type": "string", "description": "Parameter description"}
        },
        "required": ["param1"]
    }
)
def my_tool(self, args, raw_data):
    param1 = args.get("param1")
    return SwaigFunctionResult(f"Result: {param1}")
\`\`\`

## Testing

\`\`\`bash
pytest tests/ -v
\`\`\`

## Useful Commands

\`\`\`bash
urls          # Show ngrok tunnel URL
testapp       # Test local and public endpoints
webhook       # Start webhook catcher for debugging
\`\`\`
READMEEOF
print_success "README.md"

# Create sample static file
cat > web/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>SignalWire Agent</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #044cf6; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>SignalWire Agent</h1>
    <p>Your agent is running!</p>
    <p>SWML endpoint: <code>/swml</code></p>
</body>
</html>
EOF
print_success "web/index.html"

# Initialize venv with spinner
print_step "Creating virtual environment..."

VENV_DIR="/workdir/.venvs/${NAME}"
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"

# Install packages with spinner
printf "Installing packages... "
spinner='|/-\'
i=0
pip install -q flask requests signalwire-agents python-dotenv pytest > /dev/null 2>&1 &
pid=$!
while kill -0 $pid 2>/dev/null; do
    printf "\b%c" "${spinner:i%4:1}"
    i=$((i+1))
    sleep 0.1
done
wait $pid 2>/dev/null
status=$?
if [ $status -eq 0 ]; then
    printf "\bdone\n"
    print_success "Virtual environment created"
else
    printf "\bfailed\n"
    print_error "Package installation failed"
fi

echo ""
echo -e "${GREEN}Project created successfully!${NC}"
echo ""
if [ -n "$NGROK_URL" ]; then
    echo "Your agent will be available at:"
    echo "  SWML: $NGROK_URL/swml"
    echo "  Web:  $NGROK_URL/"
    echo ""
fi
echo "Run 'up' to start the agent"
echo ""

# Change to project directory and spawn new shell
cd "$PROJECT_DIR"
exec bash
