#!/bin/bash
# migrate-persistent - Migrate /workdir dotfiles to /workdir/persistent
# This script moves persistent config/data to a cleaner structure

set -e

PERSISTENT="/workdir/persistent"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}WireStarter Persistence Migration${NC}"
echo "=================================="
echo ""
echo "This will move config/data from /workdir to /workdir/persistent"
echo ""

# Check if already migrated
if [ -d "$PERSISTENT" ] && [ -f "$PERSISTENT/.migrated" ]; then
    echo -e "${YELLOW}Already migrated. Nothing to do.${NC}"
    exit 0
fi

# Create persistent directory
mkdir -p "$PERSISTENT"

# Files/directories to migrate
ITEMS=(
    ".bash_history"
    ".claude"
    ".claude.json"
    ".claude.json.backup"
    ".cloudflared"
    ".config"
    ".emacs"
    ".emacs.d"
    ".env"
    ".gemini"
    ".git-credentials"
    ".gitconfig"
    ".gitignore_global"
    ".go"
    ".noswsh"
    ".npm"
    ".npmrc"
    ".nvm"
    ".pypirc"
    ".ssh"
    ".swsh_history"
    ".venvs"
    ".vimrc"
    ".nanorc"
    "postgres"
    "logs"
    "public"
)

echo "Migrating items to $PERSISTENT:"
echo ""

for item in "${ITEMS[@]}"; do
    src="/workdir/$item"
    dst="$PERSISTENT/$item"

    if [ -e "$src" ] && [ ! -L "$src" ]; then
        # Item exists and is not a symlink
        if [ -e "$dst" ]; then
            echo -e "  ${YELLOW}SKIP${NC} $item (already exists in persistent)"
        else
            echo -e "  ${GREEN}MOVE${NC} $item"
            mv "$src" "$dst"
        fi
    elif [ -L "$src" ]; then
        # Already a symlink - check if pointing to persistent
        target=$(readlink "$src" 2>/dev/null || true)
        if [[ "$target" == *"/persistent/"* ]]; then
            echo -e "  ${BLUE}OK${NC}   $item (already linked to persistent)"
        else
            echo -e "  ${YELLOW}SKIP${NC} $item (symlink to $target)"
        fi
    else
        echo -e "  ${BLUE}--${NC}   $item (not present)"
    fi
done

# Mark as migrated
touch "$PERSISTENT/.migrated"
date > "$PERSISTENT/.migrated"

echo ""
echo -e "${GREEN}Migration complete!${NC}"
echo ""
echo "Next steps:"
echo "  1. Rebuild the container: make build && make up"
echo "  2. The new bash.rc will create symlinks automatically"
echo ""
