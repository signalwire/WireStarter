#!/bin/bash
# WireStarter Environment Setup

# Load existing .env if present
if [ -f "/workdir/.env" ]; then
    set -a
    source /workdir/.env
    set +a
fi

setup_credentials() {
    # Prepopulate with existing values
    local sw_space="${SIGNALWIRE_SPACE:-}"
    local project_id="${PROJECT_ID:-}"
    local api_token="${REST_API_TOKEN:-}"
    local ngrok_token="${NGROK_TOKEN:-}"
    local ngrok_args="${NGROK_ARGS:-}"
    local visual="${VISUAL:-vim}"

    # SignalWire Space
    sw_space=$(whiptail --inputbox "SignalWire Space Domain:" 8 60 "$sw_space" --title "SignalWire Credentials" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Project ID
    project_id=$(whiptail --inputbox "Project ID:" 8 60 "$project_id" --title "SignalWire Credentials" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # API Token
    api_token=$(whiptail --inputbox "REST API Token:" 8 60 "$api_token" --title "SignalWire Credentials" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # NGROK Token
    ngrok_token=$(whiptail --inputbox "NGROK Token (optional):" 8 60 "$ngrok_token" --title "NGROK Setup" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # NGROK Args
    ngrok_args=$(whiptail --inputbox "NGROK Args (e.g., --url yourdomain.ngrok.io):" 8 70 "$ngrok_args" --title "NGROK Setup" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Editor selection
    visual=$(whiptail --title "Default Editor" --menu "Choose your editor:" 12 50 3 \
        "vim" "" \
        "emacs" "" \
        "nano" "" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Strip .signalwire.com if included
    sw_space=$(echo "$sw_space" | sed 's/\.signalwire\.com//g')

    # Write .env file (Docker --env-file compatible format)
    cat > /workdir/.env << ENVEOF
SIGNALWIRE_SPACE=$sw_space
PROJECT_ID=$project_id
REST_API_TOKEN=$api_token
NGROK_TOKEN=$ngrok_token
NGROK_ARGS=$ngrok_args
VISUAL=$visual
WORKDIR=/workdir
ENVEOF

    # Export for current session
    set -a
    source /workdir/.env
    set +a

    # Test credentials
    local test_url="https://${sw_space}.signalwire.com/api/laml/2010-04-01/Accounts"
    local response_code=$(curl -s -o /dev/null -w "%{http_code}" "$test_url" -u "${project_id}:${api_token}")

    if [ "$response_code" = "200" ]; then
        whiptail --title "Credentials Saved" --msgbox "Credentials saved to /workdir/.env\n\n[OK] SignalWire API test successful!" 10 50
    else
        whiptail --title "Credentials Saved" --msgbox "Credentials saved to /workdir/.env\n\n[!!] SignalWire API test failed (HTTP $response_code)\nPlease verify your credentials." 12 50
    fi
}

setup_golang() {
    echo "Installing Go to /workdir/.go..."
    ARCH=$(uname -m | sed 's/aarch64/arm64/g' | sed 's/x86_64/amd64/g')

    # Get latest stable version
    GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -1)

    if [ -d "/workdir/.go" ]; then
        whiptail --title "Go Already Installed" --yesno "Go is already installed. Reinstall?" 8 50
        if [ $? -ne 0 ]; then
            return
        fi
        rm -rf /workdir/.go
    fi

    cd /tmp
    wget -q --show-progress "https://go.dev/dl/${GO_VERSION}.linux-${ARCH}.tar.gz"
    mkdir -p /workdir/.go
    tar -zxf "${GO_VERSION}.linux-${ARCH}.tar.gz" -C /workdir/.go --strip-components=1
    rm -f "${GO_VERSION}.linux-${ARCH}.tar.gz"

    whiptail --title "Go Installed" --msgbox "Go ${GO_VERSION} installed to /workdir/.go\n\nRun 'exec bash' to update your environment." 10 50
}

setup_nvm() {
    echo "Installing NVM to /workdir/.nvm..."

    if [ -d "/workdir/.nvm" ]; then
        whiptail --title "NVM Already Installed" --yesno "NVM is already installed. Reinstall?" 8 50
        if [ $? -ne 0 ]; then
            return
        fi
        rm -rf /workdir/.nvm
    fi

    mkdir -p /workdir/.nvm
    export NVM_DIR="/workdir/.nvm"
    curl -s -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash

    # Install latest LTS node
    source /workdir/.nvm/nvm.sh
    nvm install --lts

    whiptail --title "NVM Installed" --msgbox "NVM installed to /workdir/.nvm\nNode LTS installed.\n\nRun 'exec bash' to update your environment." 10 50
}

setup_pgsql() {
    PG_VERSION="15"
    NEW_PGDATA="/workdir/postgres"

    # Check if already setup
    if [ -d "$NEW_PGDATA" ] && [ -f "/workdir/.setuppgsql" ]; then
        whiptail --title "PostgreSQL Already Setup" --yesno "PostgreSQL data directory already exists. Reinitialize?\n\nWARNING: This will delete existing data!" 10 50
        if [ $? -ne 0 ]; then
            return
        fi
        sudo /etc/init.d/postgresql stop 2>/dev/null
        rm -rf "$NEW_PGDATA"
        rm -f /workdir/.setuppgsql
    fi

    echo "Setting up PostgreSQL with data in /workdir/postgres..."

    # Stop PostgreSQL if running
    sudo /etc/init.d/postgresql stop 2>/dev/null

    # Create and initialize data directory
    mkdir -p "$NEW_PGDATA"
    sudo chown postgres:postgres "$NEW_PGDATA"
    sudo chmod 700 "$NEW_PGDATA"

    echo "Initializing database cluster..."
    sudo -u postgres /usr/lib/postgresql/${PG_VERSION}/bin/initdb -D "$NEW_PGDATA"

    # Start PostgreSQL
    echo "Starting PostgreSQL..."
    sudo -u postgres /usr/lib/postgresql/${PG_VERSION}/bin/pg_ctl -D "$NEW_PGDATA" -l /workdir/postgres/logfile start

    touch /workdir/.setuppgsql

    whiptail --title "PostgreSQL Setup" --msgbox "PostgreSQL initialized in /workdir/postgres\n\nService is running." 10 50
}

setup_npm() {
    echo "Setting up npm cache persistence..."

    mkdir -p /workdir/.npm
    npm config set cache /workdir/.npm

    whiptail --title "NPM Cache" --msgbox "NPM cache set to /workdir/.npm" 8 50
}

setup_python_dev() {
    whiptail --title "Python Dev Tools" --yesno "Install Python development packages?\n\n- pdb++ (better debugger)\n- icecream (debug printing)\n- rich (beautiful output)\n- pytest + pytest-asyncio\n- uvicorn (ASGI server)\n- websockets\n- pydantic\n- loguru (logging)\n- aiohttp, httpx" 18 55
    if [ $? -ne 0 ]; then
        return
    fi

    echo "Installing Python dev packages..."
    pip3 install --break-system-packages \
        pdbpp icecream rich \
        pytest pytest-asyncio \
        uvicorn gunicorn \
        websockets websocket-client \
        pydantic pyyaml \
        loguru structlog \
        aiohttp httpx

    whiptail --title "Python Dev Tools" --msgbox "Python development packages installed!" 8 50
}

setup_audio_tools() {
    whiptail --title "Audio Tools" --yesno "Install audio/media tools for SignalWire voice apps?\n\n- ffmpeg (audio/video processing)\n- sox (sound processing)\n- pydub (Python audio)" 12 55
    if [ $? -ne 0 ]; then
        return
    fi

    echo "Installing audio tools..."
    apt-get update && apt-get install -y ffmpeg sox
    pip3 install --break-system-packages pydub soundfile

    whiptail --title "Audio Tools" --msgbox "Audio tools installed!\n\nffmpeg, sox, pydub ready to use." 10 50
}

setup_ssh_key() {
    if [ -f "/workdir/.ssh/id_ed25519" ]; then
        whiptail --title "SSH Key Exists" --yesno "SSH key already exists at /workdir/.ssh/id_ed25519\n\nRegenerate? (This will overwrite!)" 10 55
        if [ $? -ne 0 ]; then
            return
        fi
    fi

    local email=$(whiptail --inputbox "Email for SSH key:" 8 60 "" --title "SSH Key Setup" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    mkdir -p /workdir/.ssh
    chmod 700 /workdir/.ssh

    ssh-keygen -t ed25519 -C "$email" -f /workdir/.ssh/id_ed25519 -N ""

    # Link to home
    rm -rf ~/.ssh
    ln -s /workdir/.ssh ~/.ssh

    local pubkey=$(cat /workdir/.ssh/id_ed25519.pub)

    whiptail --title "SSH Key Generated" --msgbox "SSH key generated!\n\nPublic key:\n${pubkey}\n\nAdd this to GitHub/GitLab." 16 70
}

setup_git_identity() {
    local current_name=$(git config --global user.name 2>/dev/null)
    local current_email=$(git config --global user.email 2>/dev/null)

    local name=$(whiptail --inputbox "Git user name:" 8 60 "$current_name" --title "Git Identity" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    local email=$(whiptail --inputbox "Git email:" 8 60 "$current_email" --title "Git Identity" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Write to /workdir/.gitconfig for persistence
    cat > /workdir/.gitconfig << GITEOF
[user]
    name = $name
    email = $email
[init]
    defaultBranch = main
[core]
    editor = ${VISUAL:-vim}
[pull]
    rebase = false
GITEOF

    # Link to home
    ln -sf /workdir/.gitconfig ~/.gitconfig

    whiptail --title "Git Identity" --msgbox "Git configured!\n\nName: $name\nEmail: $email\n\nSaved to /workdir/.gitconfig" 12 50
}

setup_ai_keys() {
    # Load current values
    local anthropic_key="${ANTHROPIC_API_KEY:-}"
    local gemini_key="${GEMINI_API_KEY:-}"

    anthropic_key=$(whiptail --inputbox "Anthropic API Key (for Claude Code):" 8 70 "$anthropic_key" --title "AI API Keys" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    gemini_key=$(whiptail --inputbox "Google Gemini API Key:" 8 70 "$gemini_key" --title "AI API Keys" 3>&1 1>&2 2>&3)
    [ $? -ne 0 ] && return

    # Append to .env if not already there, or update
    if [ -f "/workdir/.env" ]; then
        # Remove old keys if present
        sed -i '/^ANTHROPIC_API_KEY=/d' /workdir/.env
        sed -i '/^GEMINI_API_KEY=/d' /workdir/.env
    fi

    # Append new keys
    echo "ANTHROPIC_API_KEY=$anthropic_key" >> /workdir/.env
    echo "GEMINI_API_KEY=$gemini_key" >> /workdir/.env

    # Export for current session
    export ANTHROPIC_API_KEY="$anthropic_key"
    export GEMINI_API_KEY="$gemini_key"

    whiptail --title "AI API Keys" --msgbox "API keys saved to /workdir/.env\n\nClaude Code and Gemini CLI are ready to use." 10 55
}

clean_environment() {
    CLEAN_CHOICE=$(whiptail --title "Clean Environment" --menu "What do you want to clean?" 16 60 6 \
        "1" "Clean all Python venvs (/workdir/.venvs/)" \
        "2" "Clean NPM cache (/workdir/.npm/)" \
        "3" "Clean pip cache" \
        "4" "Clean all caches (npm + pip)" \
        "5" "Full reset (remove all dev tools)" \
        "6" "Back to main menu" \
        3>&1 1>&2 2>&3)

    [ $? -ne 0 ] && return

    case $CLEAN_CHOICE in
        "1")
            if whiptail --title "Confirm" --yesno "Delete ALL Python virtual environments?" 8 50; then
                rm -rf /workdir/.venvs
                mkdir -p /workdir/.venvs
                whiptail --title "Cleaned" --msgbox "All venvs deleted." 8 40
            fi
            ;;
        "2")
            rm -rf /workdir/.npm/*
            whiptail --title "Cleaned" --msgbox "NPM cache cleared." 8 40
            ;;
        "3")
            pip3 cache purge 2>/dev/null
            whiptail --title "Cleaned" --msgbox "Pip cache cleared." 8 40
            ;;
        "4")
            rm -rf /workdir/.npm/*
            pip3 cache purge 2>/dev/null
            whiptail --title "Cleaned" --msgbox "All caches cleared." 8 40
            ;;
        "5")
            if whiptail --title "DANGER" --yesno "This will remove:\n\n- All venvs\n- Go installation\n- NVM + Node\n- PostgreSQL data\n- All caches\n\nCredentials and SSH keys will be kept.\n\nAre you SURE?" 18 50; then
                rm -rf /workdir/.venvs
                rm -rf /workdir/.go
                rm -rf /workdir/.nvm
                rm -rf /workdir/.npm
                rm -rf /workdir/postgres
                rm -f /workdir/.setuppgsql
                pip3 cache purge 2>/dev/null
                whiptail --title "Reset Complete" --msgbox "Environment reset.\n\nRun 'exec bash' and then 'setup' to reinstall." 10 50
            fi
            ;;
    esac
}

setup_all() {
    whiptail --title "Setup All" --yesno "This will setup:\n\n- Go (latest)\n- NVM + Node LTS\n- PostgreSQL\n- NPM cache\n- Python dev tools\n\nContinue?" 16 50
    if [ $? -ne 0 ]; then
        return
    fi

    setup_golang
    setup_nvm
    setup_pgsql
    setup_npm
    setup_python_dev

    whiptail --title "Setup Complete" --msgbox "All development tools installed!\n\nRun 'exec bash' to update your environment." 10 50
}

show_status() {
    STATUS=""

    # Credentials status
    if [ -n "$SIGNALWIRE_SPACE" ] && [ -n "$PROJECT_ID" ] && [ -n "$REST_API_TOKEN" ]; then
        STATUS+="SignalWire: [OK] ${SIGNALWIRE_SPACE}\n"
    else
        STATUS+="SignalWire: [--] Not configured\n"
    fi

    if [ -n "$NGROK_TOKEN" ]; then
        STATUS+="NGROK: [OK] Configured\n"
    else
        STATUS+="NGROK: [--] Not configured\n"
    fi

    STATUS+="\n"

    if [ -d "/workdir/.go" ]; then
        GO_VER=$(/workdir/.go/bin/go version 2>/dev/null | awk '{print $3}')
        STATUS+="Go: [OK] ${GO_VER}\n"
    else
        STATUS+="Go: [--] Not installed\n"
    fi

    if [ -d "/workdir/.nvm" ]; then
        STATUS+="NVM: [OK] Installed\n"
    else
        STATUS+="NVM: [--] Not installed\n"
    fi

    if [ -f "/workdir/.setuppgsql" ]; then
        STATUS+="PostgreSQL: [OK] Configured\n"
    else
        STATUS+="PostgreSQL: [--] Not configured\n"
    fi

    if [ -d "/workdir/.npm" ]; then
        STATUS+="NPM Cache: [OK] Persistent\n"
    else
        STATUS+="NPM Cache: [--] Default\n"
    fi

    # Count venvs
    if [ -d "/workdir/.venvs" ]; then
        VENV_COUNT=$(ls -1 /workdir/.venvs/ 2>/dev/null | wc -l)
        STATUS+="Python venvs: [OK] ${VENV_COUNT} environments\n"
    else
        STATUS+="Python venvs: [--] None\n"
    fi

    STATUS+="\n"

    # SSH key
    if [ -f "/workdir/.ssh/id_ed25519" ]; then
        STATUS+="SSH Key: [OK] Configured\n"
    else
        STATUS+="SSH Key: [--] Not configured\n"
    fi

    # Git identity
    if [ -f "/workdir/.gitconfig" ]; then
        local git_name=$(git config --global user.name 2>/dev/null)
        STATUS+="Git Identity: [OK] ${git_name}\n"
    else
        STATUS+="Git Identity: [--] Not configured\n"
    fi

    # AI keys
    if [ -n "$ANTHROPIC_API_KEY" ]; then
        STATUS+="Claude API: [OK] Configured\n"
    else
        STATUS+="Claude API: [--] Not configured\n"
    fi

    if [ -n "$GEMINI_API_KEY" ]; then
        STATUS+="Gemini API: [OK] Configured\n"
    else
        STATUS+="Gemini API: [--] Not configured\n"
    fi

    # Audio tools
    if command -v ffmpeg &>/dev/null; then
        STATUS+="Audio Tools: [OK] Installed\n"
    else
        STATUS+="Audio Tools: [--] Not installed\n"
    fi

    whiptail --title "Environment Status" --msgbox "$STATUS" 28 55
}

# Main menu
while true; do
    CHOICE=$(whiptail --title "WireStarter Environment Setup" --menu "Select an option:" 24 60 15 \
        "1" "Setup SignalWire & NGROK Credentials" \
        "2" "Setup AI API Keys (Claude/Gemini)" \
        "3" "Setup Git Identity" \
        "4" "Setup SSH Key" \
        "5" "---" \
        "6" "Setup Go (latest stable)" \
        "7" "Setup NVM + Node.js" \
        "8" "Setup PostgreSQL" \
        "9" "Setup Python Dev Tools" \
        "10" "Setup Audio Tools (ffmpeg/sox)" \
        "11" "Setup All Dev Tools" \
        "12" "---" \
        "13" "Show Status" \
        "14" "Clean Environment" \
        "15" "Exit" \
        3>&1 1>&2 2>&3)

    exitstatus=$?
    if [ $exitstatus -ne 0 ]; then
        exit 0
    fi

    case $CHOICE in
        "1") setup_credentials ;;
        "2") setup_ai_keys ;;
        "3") setup_git_identity ;;
        "4") setup_ssh_key ;;
        "6") setup_golang ;;
        "7") setup_nvm ;;
        "8") setup_pgsql ;;
        "9") setup_python_dev ;;
        "10") setup_audio_tools ;;
        "11") setup_all ;;
        "13") show_status ;;
        "14") clean_environment ;;
        "15") exit 0 ;;
    esac
done
